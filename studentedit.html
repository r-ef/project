<html>
<head>
    <title>edit student profile | internly</title>
    <link rel="stylesheet" href="style.css">
     <!-- linking the css file to this page -->
</head>
<body class="ligbody"> <!--class for light appearance style-->

    <ul id="navbar">
        <li class="dir" id="logo"><a href="studenthome.html" target="_self"> <img src="website logo.png" height="50" width="auto" /></a> </li>
        <li class="dir" id="navtext"><a href="studenthome.html" target="_self">Home</a></li>
        <li class="dir" id="navtext"><a href="internshipslist.html" target="_blank">Internships</a></li>
        <li class="dir" id="navtext"><a href="studentapply.html" target="_self">Apply</a></li>
        <li class="dir" id="navtext"><a href="currentstudent.html" target="_self">Current Applications</a></li>
        <li class="log" id="navtext"><a href="home.html" target="_self">Log out</a></li>
        <li class="log" id="navtext"><a href="studentaccount.html" target="_self"><img src="profile icon.png" height="20" width="auto"/></a></li>
    </ul>

    <form class="ligform" id="studentEditForm">
        <table class="signtab" border="0">
            <tr>
                <td colspan="2" align="center"><h3>Edit Account Details</h3></td>
            </tr>
            <tr>
                <td>First Name:</td>
                <td><input type="text" class="liginput" name="stu_fname" size="30"></td>
            </tr>
            <tr>
                <td>Last Name:</td>
                <td><input type="text" class="liginput" name="stu_lname" size="30"></td>
            </tr>
            <tr>
                <td>Date of Birth:</td>
                <td><input type="date" class="ligdate" name="stu_dob"></td>
            </tr>
            <tr>
                <td>Gender:</td>
                <td><input type="radio" class="liginput" name="stu_gen" value="f">Female
                <input type="radio" class="liginput" name="stu_gen" value="m">Male </td>
            </tr>
            <tr>
                <td>E-mail:</td>
                <td><input type="email" class="liginput" name="stu_email" size="30"></td>
            </tr>
            <tr>
                <td>Account Password:</td>
                <td><input type="password" class="liginput" name="stud_pass" size="30" placeholder="Leave blank to keep current password"></td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="submit" class="butn">Save Changes</button>
                </td>
            </tr>
        </table>
    </form>
    <!--students will be able to update whatever info they wish by filling out the necessary input-->
    <script>
    // Load current student data when page loads
    async function loadStudentData() {
        try {
            const response = await fetch('http://localhost:3000/student/profile', {
                credentials: 'include'
            });
            
            if (response.status === 401) {
                alert('Please log in first');
                window.location.href = 'studentsignin.html';
                return;
            }
            
            if (!response.ok) {
                throw new Error('Failed to load profile data');
            }
            
            const studentData = await response.json();
            
            // Pre-populate form fields
            document.querySelector('input[name="stu_fname"]').value = studentData.fname || '';
            document.querySelector('input[name="stu_lname"]').value = studentData.lname || '';
            document.querySelector('input[name="stu_dob"]').value = studentData.dob || '';
            document.querySelector('input[name="stu_email"]').value = studentData.email || '';
            
            // Set gender radio button
            if (studentData.gender) {
                const genderRadio = document.querySelector(`input[name="stu_gen"][value="${studentData.gender}"]`);
                if (genderRadio) {
                    genderRadio.checked = true;
                }
            }
        } catch (error) {
            console.error('Error loading student data:', error);
            alert('Failed to load profile data. Please try again.');
        }
    }

    // Load data when page loads
    loadStudentData();

    document.getElementById('studentEditForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const fname = document.querySelector('input[name="stu_fname"]').value;
        const lname = document.querySelector('input[name="stu_lname"]').value;
        const dob = document.querySelector('input[name="stu_dob"]').value;
        const gender = document.querySelector('input[name="stu_gen"]:checked') ? document.querySelector('input[name="stu_gen"]:checked').value : '';
        const email = document.querySelector('input[name="stu_email"]').value;
        const password = document.querySelector('input[name="stud_pass"]').value;
        
        // Only include password if it's not empty
        const payload = { fname, lname, dob, gender, email };
        if (password.trim()) {
            payload.password = password;
        }
        
        try {
            const response = await fetch('http://localhost:3000/student/profile/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            
            if (response.status === 401) {
                alert('Please log in first');
                window.location.href = 'studentsignin.html';
                return;
            }
            
            if (response.ok) {
                alert('Profile updated successfully');
                window.location.href = 'studentaccount.html';
            } else {
                const errorData = await response.json();
                alert('Update failed: ' + (errorData.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Update failed. Please try again.');
        }
    });
    </script>
</body>
</html>