<html>
    <head>
        <title>internship application | internly </title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body class="ligbody">

        <ul id="navbar">
            <li class="dir" id="logo"><a href="studenthome.html" target="_self"> <img src="website logo.png" height="50" width="auto" /></a> </li>
            <li class="dir" id="navtext"><a href="studenthome.html" target="_self">home</a></li>
            <li class="dir" id="navtext"><a href="internshipslist.html" target="_blank">internships</a></li>
            <li class="dir" id="navtext"><a href="studentapply.html" target="_self">apply</a></li>
            <li class="dir" id="navtext"><a href="currentstudent.html" target="_self">current applications</a></li>
            <li class="log" id="navtext"><a href="home.html" target="_self">log out</a></li>
            <li class="log" id="navtext"><a href="studentaccount.html" target="_self"><img src="profile icon.png" height="20" width="auto"/></a></li>
        </ul>

        <form class="ligform" id="studentApplyForm">
            <table class="signtab" border="0">
                <tr>
                    <td colspan="2" align="center"><h3>applicant details</h3></td>
                </tr>
                <tr>
                    <td>first name:</td>
                    <td><input type="text" class="liginput" name="stu_fname" id="stu_fname" size="30" required></td>
                </tr>
                <tr>
                    <td>last name:</td>
                    <td><input type="text" class="liginput" name="stu_lname" id="stu_lname" size="30" required></td>
                 </tr>
                 <tr>
                    <td>date of birth:</td>
                    <td><input type="date" class="ligdate" name="stu_dob" id="stu_dob" required></td>
                 </tr>
                 <tr>
                    <td>gender:</td>
                    <td><input type="radio" class="liginput" name="stu_gen" value="f" required>female
                    <input type="radio" class="liginput" name="stu_gen" value="m" required>male </td>
                 </tr>
                <tr>
                    <td>e-mail:</td>
                    <td><input type="email" class="liginput" name="stu_email" id="stu_email" size="30" required></td>
                </tr>
                <tr>
                    <td>internship:</td>
                    <td>
                        <select class="liginput" name="internship_id" id="internship_select" required>
                            <option value="">select an internship...</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>resume upload:</td>
                    <td><input type="file" name="resume" accept=".pdf,.doc,.docx" style="margin-bottom: 15px;" required></td>
                </tr>
                <tr>
                    <td colspan="2"><input type="submit" class="butn" value="apply"></td>
                </tr>
            </table>
        </form>

        <script>
        // load student profile data and populate form
        async function loadStudentProfile() {
            try {
                const response = await fetch('http://localhost:3000/student/profile', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const studentData = await response.json();
                    document.getElementById('stu_fname').value = studentData.fname || '';
                    document.getElementById('stu_lname').value = studentData.lname || '';
                    document.getElementById('stu_dob').value = studentData.dob || '';
                    document.getElementById('stu_email').value = studentData.email || '';
                    
                    // set gender radio button
                    if (studentData.gender) {
                        const genderRadios = document.querySelectorAll('input[name="stu_gen"]');
                        genderRadios.forEach(radio => {
                            if (radio.value === studentData.gender) {
                                radio.checked = true;
                            }
                        });
                    }
                } else {
                    console.error('failed to load student profile');
                    window.location.href = 'studentsignin.html';
                }
            } catch (error) {
                console.error('error loading student profile:', error);
                window.location.href = 'studentsignin.html';
            }
        }

        // load available internships and populate dropdown
        async function loadInternships() {
            try {
                const response = await fetch('http://localhost:3000/internships', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const internships = await response.json();
                    const select = document.getElementById('internship_select');
                    
                    // clear existing options except the first one
                    select.innerHTML = '<option value="">select an internship...</option>';
                    
                    // add internship options
                    internships.forEach(internship => {
                        const option = document.createElement('option');
                        option.value = internship.id;
                        option.textContent = `${internship.title} - ${internship.company_name} (${internship.type})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('failed to load internships');
                    document.getElementById('internship_select').innerHTML = '<option value="">error loading internships</option>';
                }
            } catch (error) {
                console.error('error loading internships:', error);
                document.getElementById('internship_select').innerHTML = '<option value="">error loading internships</option>';
            }
        }

        // handle form submission
        document.getElementById('studentApplyForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // validate internship selection
            const internshipId = formData.get('internship_id');
            if (!internshipId) {
                alert('please select an internship');
                return;
            }
            
            // validate resume upload
            const resumeFile = formData.get('resume');
            if (!resumeFile || resumeFile.size === 0) {
                alert('please upload your resume');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/student/apply', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('application submitted successfully!');
                    window.location.href = 'studenthome.html';
                } else {
                    const errorData = await response.json();
                    alert('application failed: ' + (errorData.error || 'unknown error'));
                }
            } catch (error) {
                console.error('error submitting application:', error);
                alert('application failed: network error');
            }
        });

        // load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentProfile();
            loadInternships();
        });
        </script>
    </body>
</html>