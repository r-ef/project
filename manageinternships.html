<html>
<head>
  <title>manage internships | internly</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="darbody">

  <!-- Navigation Bar to go throught the other pages -->
    <ul id="darnavbar">
        <li class="dir" id="logo"><a href="companyhome.html" target="_self"> <img src="website admin logo.png" height="50" width="auto" /></a> </li>
        <li class="dir" id="navtext"><a href="companyhome.html" target="_self">home</a></li>
        <li class="dir" id="navtext"><a href="manageinternships.html" target="_self">manage internships</a></li>
        <li class="dir" id="navtext"><a href="manageapplications.html" target="_self">manage applications</a></li>
        <li class="log" id="navtext"><a href="home.html" target="_self">log out</a></li>
        <li class="log" id="navtext"><a href="companyaccount.html" target="_self"><img src="profile icon.png" height="20" width="auto"/></a></li>
    </ul>

  <div class="darappform">
    <h2>post new internship</h2>
    <form id="internshipForm" class="darform">
      <table class="signtab" border="0">
        <tr>
          <td>title:</td>
          <td><input type="text" class="darinput" name="title" size="30" required></td>
        </tr>
        <tr>
          <td>type:</td>
          <td>
            <select class="darinput" name="type" required>
              <option value="">select type...</option>
              <option value="summer">summer</option>
              <option value="fall">fall</option>
              <option value="spring">spring</option>
              <option value="winter">winter</option>
              <option value="year-round">year-round</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>skills required:</td>
          <td><input type="text" class="darinput" name="skills" size="30" required></td>
        </tr>
        <tr>
          <td>salary (per month):</td>
          <td><input type="number" class="darinput" name="salary" size="30" required></td>
        </tr>
        <tr>
          <td>start date:</td>
          <td><input type="date" class="darinput" name="start_date" required></td>
        </tr>
        <tr>
          <td>end date:</td>
          <td><input type="date" class="darinput" name="end_date" required></td>
        </tr>
        <tr>
          <td>application deadline:</td>
          <td><input type="date" class="darinput" name="deadline" required></td>
        </tr>
        <tr>
          <td>description:</td>
          <td><textarea class="darinput" name="description" rows="4" cols="30" required></textarea></td>
        </tr>
        <tr>
          <td colspan="2"><input type="submit" class="butn" value="post internship"></td>
        </tr>
      </table>
    </form>

    <h2>current internships</h2>
    <div id="internshipsList">
      <!-- internships will be loaded here -->
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadInternships();
});

async function loadInternships() {
    try {
        const response = await fetch('http://localhost:3000/company/internships', {
            credentials: 'include'
        });
        
        if (response.status === 401) {
            alert('please sign in to manage internships.');
            window.location.href = 'companysignin.html';
            return;
        }
        
        if (!response.ok) {
            throw new Error('failed to load internships');
        }
        
        const internships = await response.json();
        displayInternships(internships);
    } catch (error) {
        console.error('error loading internships:', error);
        document.getElementById('internshipsList').innerHTML = '<p style="color:red">error loading internships</p>';
    }
}

function displayInternships(internships) {
    const container = document.getElementById('internshipsList');
    
    if (!internships.length) {
        container.innerHTML = '<p>no internships posted yet</p>';
        return;
    }
    
    container.innerHTML = internships.map(internship => `
        <div class="internship-item" data-id="${internship.id}">
            <h3>${internship.title}</h3>
            <p><strong>type:</strong> ${internship.type}</p>
            <p><strong>skills:</strong> ${internship.skills}</p>
            <p><strong>salary:</strong> $${internship.salary}/month</p>
            <p><strong>dates:</strong> ${formatDate(internship.start_date)} - ${formatDate(internship.end_date)}</p>
            <p><strong>deadline:</strong> ${formatDate(internship.deadline)}</p>
            <p><strong>description:</strong> ${internship.description}</p>
            <div class="internship-actions">
                <button onclick="editInternship(${internship.id})" class="edit-btn">edit</button>
                <button onclick="deleteInternship(${internship.id})" class="delete-btn">delete</button>
            </div>
        </div>
    `).join('');
}

async function deleteInternship(internshipId) {
    if (!confirm('are you sure you want to delete this internship?')) {
        return;
    }
    
    try {
        const response = await fetch(`http://localhost:3000/internships/${internshipId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (response.ok) {
            alert('internship deleted successfully');
            loadInternships();
        } else {
            const error = await response.json();
            alert('failed to delete internship: ' + (error.error || 'unknown error'));
        }
    } catch (error) {
        console.error('error deleting internship:', error);
        alert('failed to delete internship: network error');
    }
}

function editInternship(internshipId) {
    // redirect to edit page
    window.location.href = `internshipedit.html?id=${internshipId}`;
}

document.getElementById('internshipForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const internshipData = {
        title: formData.get('title'),
        type: formData.get('type'),
        skills: formData.get('skills'),
        salary: parseInt(formData.get('salary')),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        deadline: formData.get('deadline'),
        description: formData.get('description')
    };
    
    try {
        const response = await fetch('http://localhost:3000/internships', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(internshipData)
        });
        
        if (response.ok) {
            alert('internship posted successfully');
            event.target.reset();
            loadInternships();
        } else {
            const error = await response.json();
            alert('failed to post internship: ' + (error.error || 'unknown error'));
        }
    } catch (error) {
        console.error('error posting internship:', error);
        alert('failed to post internship: network error');
    }
});

function formatDate(dateString) {
    if (!dateString) return 'n/a';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

document.querySelector('a[href="home.html"]').addEventListener('click', async function(event) {
    event.preventDefault();
    try {
        const response = await fetch('http://localhost:3000/company/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            console.log('logged out successfully');
        } else {
            console.error('logout failed');
        }
    } catch (error) {
        console.error('logout error:', error);
    }
    
    window.location.href = 'home.html';
});
</script>

<style>
.internship-item {
    border: 1px solid #ddd;
    padding: 15px;
    margin: 10px 0;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.internship-actions {
    margin-top: 10px;
}

.edit-btn {
    background-color: #2196F3;
    color: white;
    border: none;
    padding: 5px 10px;
    margin-right: 5px;
    border-radius: 3px;
    cursor: pointer;
}

.delete-btn {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
}

.edit-btn:hover {
    background-color: #1976D2;
}

.delete-btn:hover {
    background-color: #d32f2f;
}
</style>
</body>
</html>