<html>
<head>
  <title>internships | internly</title>
  <link rel="stylesheet" href="style.css" />
  <script src="internshipsearch.js" defer></script>
</head>
<body class="ligbody">

  <!-- Navigation Bar to go throught the other pages -->
  <ul id="navbar">
    <li class="dir" id="logo"><a href="home.html" target="_self"> <img src="website logo.png" height="50" width="auto" /></a> </li>
    <li class="dir" id="navtext"><a href="home.html" target="_self">home</a></li>
    <li class="dir" id="navtext"><a href="usinternshipslist.html" target="_blank">Internships</a></li> <!-- internship list view file is different due to the different navigation bar available to logged in students and logged out ones-->
    <li class="log" id="navtext"><a href="companysignin.html" target="_self">company sign in</a></li>
    <li class="log" id="navtext"><a href="studentsignin.html" target="_self">student sign in</a> </li>
  </ul>

<form class="ligformmid"><!--adding a class to the form tag so that i may style it easily in the css file, using get action as i am requesting to get data from the server-->
    <table class="signtab" border="0" width="100%"> <!-- adding a class to the table tag so that i may style it easily in the css file, making the width 100% so the contents spread out-->
        <tr>
            <th colspan="5" align="center"><h4>filter options</h4></th>
        </tr>
        <tr>
            <td align="center">company</td>
            <td align="center">internship type</td>
            <td align="center">location</td>
            <td align="center">salary</td>
            <td align="center">action</td>
        </tr>
        <tr>
            <td align="center"><select name="company" class="liginput" id="companyDropdown">
                <option value="" disabled selected hidden>select...</option>
            </select></td>
            <td align="center"><select name="seartype" class="liginput" id="typeDropdown">
                <option value="" disabled selected hidden>select...</option>
                <option value="remote">remote</option>
                <option value="on-site">on-site</option>
            </select></td>
            <td align="center"><select name="searloc" class="liginput" id="locationDropdown">
                <option value="" disabled selected hidden>select...</option>
            </select></td>
            <td align="center"><input type="range" min="1000" max="8000" step="1000" value="1000" onchange="getSalary(this.value)" id="searsal"><span id="number">1000+ aed</span></td>
            <td align="center">
                <button type="submit" class="smallbutn">search</button>
                <button type="button" class="smallbutn" onclick="clearFilters()" style="margin-left: 10px;">clear filters</button>
            </td>
        </tr>
    </table>
  </form>

  <form class="ligappformbig" action="POST"><!--adding a class to the form tag so that i may style it easily in the css file, using get action as i am requesting to get data from the server-->
    <table class="signtab" border="0" width="100%"> <!-- adding a class to the table tag so that i may style it easily in the css file, making the width 100% so the contents spread out-->
        <tr>
            <th colspan="8" align="center"><h1>available internships</h1></th>
        </tr>
        <tr>
          <th align="center">company</th>
          <th align="center">internship <br /> title</th>
          <th align="center">internship <br /> type</th>
          <th align="center">skills required</th>
          <th align="center">salary</th>
          <th align="center">duration</th>
          <th align="center">application <br /> deadline</th>
          <th align="center">internship details</th>
        </tr>
        <tbody id="internshipsTableBody">
          <!-- Internships will be inserted here -->
        </tbody>
    </table>
  </form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadInternships();
  loadCompanies();
  loadLocations();
});

async function loadInternships(filters = {}) {
  try {
    const queryParams = new URLSearchParams(filters);
    const url = filters.company || filters.type || filters.location || filters.salary 
      ? `http://localhost:3000/internships/filter?${queryParams}` 
      : 'http://localhost:3000/internships';
    
    const response = await fetch(url);
    const internships = await response.json();
    console.log(internships);
    displayInternships(internships);
  } catch (error) {
    console.error('Error loading internships:', error);
  }
}

function displayInternships(internships) {
  const container = document.getElementById('internshipsTableBody');
  if (internships.length === 0) {
    container.innerHTML = '<tr><td colspan="8" align="center">No internships found</td></tr>';
    return;
  }
  
  const html = internships.map(internship => `
    <tr>
      <td align="center">${internship.company_name || 'N/A'}</td>
      <td align="center">${internship.title || 'N/A'}</td>
      <td align="center">${internship.type || 'N/A'}</td>
      <td align="center">${internship.skills || 'N/A'}</td>
      <td align="center">${internship.salary ? internship.salary + ' AED' : 'N/A'}</td>
      <td align="center">${formatDate(internship.start_date)} - ${formatDate(internship.end_date)}</td>
      <td align="center">${formatDate(internship.deadline)}</td>
      <td align="center">${internship.description || 'N/A'}</td>
    </tr>
  `).join('');
  
  container.innerHTML = html;
}

async function loadCompanies() {
  try {
    const response = await fetch('http://localhost:3000/companies');
    const companies = await response.json();
    const dropdown = document.getElementById('companyDropdown');
    dropdown.innerHTML = `
      <option value="" disabled selected hidden>Select...</option>
      ${companies.map(company => `<option value="${company}">${company}</option>`).join('')}
    `;
  } catch (error) {
    console.error('Error loading companies:', error);
  }
}

async function loadLocations() {
  try {
    const response = await fetch('http://localhost:3000/locations');
    const locations = await response.json();
    const dropdown = document.getElementById('locationDropdown');
    dropdown.innerHTML = `
      <option value="" disabled selected hidden>Select...</option>
      ${locations.map(location => `<option value="${location}">${location}</option>`).join('')}
    `;
  } catch (error) {
    console.error('Error loading locations:', error);
  }
}

document.querySelector('.ligformmid').addEventListener('submit', function(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const filters = {
    company: formData.get('company'),
    type: formData.get('seartype'),
    location: formData.get('searloc'),
    salary: document.getElementById('searsal').value
  };
  
  Object.keys(filters).forEach(key => {
    if (!filters[key] || filters[key] === '') {
      delete filters[key];
    }
  });
  
  loadInternships(filters);
});

function clearFilters() {
  // Reset all filter fields
  document.getElementById('companyDropdown').value = '';
  document.getElementById('typeDropdown').value = '';
  document.getElementById('locationDropdown').value = '';
  document.getElementById('searsal').value = '1000';
  document.getElementById('number').textContent = '1000+ aed';
  
  // Reload internships without any filters
  loadInternships();
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleDateString();
}
</script>
</body>
</html>